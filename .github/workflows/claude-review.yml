name: Claude Code Review

on:
  workflow_run:
    workflows: ["Pull Request Update"]
    types: [completed]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read

jobs:
  auto-review:
    # Automatically review PRs from claude/* branches after CI passes.
    # Triggered via workflow_run so the review happens after CI (and any CI-fix attempts).
    if: >-
      github.repository_owner == 'viamrobotics' &&
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'claude/')
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Find PR for branch
        id: pr
        # actions/github-script@v8.0.0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const branch = context.payload.workflow_run.head_branch;
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (pulls.length === 0) {
              core.info('No open PR found for branch ' + branch);
              core.setOutput('found', 'false');
              return;
            }

            const pr = pulls[0];
            core.setOutput('found', 'true');
            core.setOutput('number', String(pr.number));
            core.setOutput('title', pr.title);
            core.setOutput('branch', branch);

      # actions/checkout@v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        if: steps.pr.outputs.found == 'true'
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 1

      - name: Install dependencies
        if: steps.pr.outputs.found == 'true'
        run: npm ci

      # anthropics/claude-code-action@v1.0.54
      - uses: anthropics/claude-code-action@0cf5eeec4f908121edd03a81411b55485994f8d3
        if: steps.pr.outputs.found == 'true'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: .claude/settings.ci.json
          allowed_bots: "claude[bot]"
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr.outputs.number }}

            You are a senior staff engineer performing a rigorous code review.
            This PR was authored by an AI agent — assume nothing and verify everything.

            ## Setup

            1. Read CLAUDE.md for repository conventions and constraints (including the CI Environment section).
            2. Read every modified file in full to understand context beyond the diff.

            ## Review Checklist — apply high standards

            **Correctness**
            - Trace the logic end-to-end. Look for off-by-one errors, null/undefined dereferences, unhandled promise rejections, and incorrect type narrowing.
            - Verify error handling paths: are errors caught, propagated, or silently swallowed?
            - Check boundary conditions and edge cases the implementation may have missed.

            **Security**
            - Check for injection risks (command injection, prototype pollution).
            - Verify no secrets, credentials, or internal URLs are hardcoded.
            - Ensure user/external input is validated at system boundaries.

            **API Design & Backwards Compatibility**
            - If the public API surface changed (exports in src/main.ts), verify it is backwards-compatible.
            - Check naming consistency with existing APIs in the codebase.
            - Verify new types/interfaces follow existing conventions.

            **Patterns & Conventions**
            - The codebase follows strict conventions. Verify the PR does not introduce new abstractions, utilities, or patterns that diverge from existing code.
            - Check that the change is minimal — no unnecessary refactors, no scope creep.
            - Ensure src/gen/ was not modified.

            **Tests**
            - Verify tests exist for the changed behavior.
            - Tests should cover meaningful logic, edge cases, and error paths — not just happy paths.
            - Check that test assertions are specific (not just `toBeDefined()` or `toBeTruthy()`).

            **Performance**
            - Look for unnecessary allocations, missing cleanup/disposal, or O(n²) patterns.
            - Check for resource leaks (unclosed streams, missing event listener removal).

            ## Actions

            - If you find issues, fix them directly: edit the files, run `npm run _prettier -- --write` then `npm run lint:prettier`, commit, and push.
            - Use inline comments on specific lines for targeted feedback.
            - After reviewing and fixing, post a review summary using `gh pr review` with your findings.
            - If the code is solid, approve with `gh pr review --approve` and a brief summary.
            - Use `--comment`, `--approve`, or `--request-changes` as appropriate.
          claude_args: |
            --model claude-sonnet-4-6
            --max-turns 30
            --append-system-prompt "You are a demanding code reviewer. Your job is to catch bugs, security issues, and convention violations that the implementing agent missed. Be thorough and skeptical. Do not rubber-stamp changes. If something looks suspicious, investigate it fully before approving."
            --allowedTools "Edit,Read,Write,Glob,Grep,mcp__github_inline_comment__create_inline_comment,Bash(npm run _prettier*),Bash(npm run lint:prettier*),Bash(git add *),Bash(git commit *),Bash(git push *),Bash(git status*),Bash(git diff*),Bash(git log*),Bash(git checkout *),Bash(git branch *),Bash(git rev-parse *),Bash(git fetch *),Bash(gh pr review*),Bash(gh pr comment*),Bash(gh pr diff*),Bash(gh pr view*)"

      - name: Notify Slack of failure
        # slackapi/slack-github-action@v2.1.1
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a
        if: ${{ failure() && steps.pr.outputs.found == 'true' }}
        with:
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "Claude Code Review failed for PR #${{ steps.pr.outputs.number }}: ${{ steps.pr.outputs.title }}\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "username": "Typescript SDK",
              "icon_url": "https://media.tenor.com/bZMubztJxGkAAAAe/charlie-brown-walking-charlie-brown.png"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_TEAM_SDK_WEBHOOK_URL }}

  on-demand-review:
    # Triggered by @claude mention on any PR comment. Review-only, no pushes.
    if: >-
      github.repository_owner == 'viamrobotics' &&
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
      )
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      # actions/checkout@v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: npm ci

      # anthropics/claude-code-action@v1.0.54
      - uses: anthropics/claude-code-action@0cf5eeec4f908121edd03a81411b55485994f8d3
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: .claude/settings.ci.json
          trigger_phrase: "@claude"
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}

            You are a senior staff engineer performing a rigorous code review.
            This is a review-only pass — do NOT push code or make changes.

            ## Setup

            1. Read CLAUDE.md for repository conventions and constraints (including the CI Environment section).
            2. Read every modified file in full to understand context beyond the diff.

            ## Review Checklist — apply high standards

            **Correctness**
            - Trace the logic end-to-end. Look for off-by-one errors, null/undefined dereferences, unhandled promise rejections, and incorrect type narrowing.
            - Verify error handling paths: are errors caught, propagated, or silently swallowed?
            - Check boundary conditions and edge cases the implementation may have missed.

            **Security**
            - Check for injection risks (command injection, prototype pollution).
            - Verify no secrets, credentials, or internal URLs are hardcoded.
            - Ensure user/external input is validated at system boundaries.

            **API Design & Backwards Compatibility**
            - If the public API surface changed (exports in src/main.ts), verify it is backwards-compatible.
            - Check naming consistency with existing APIs in the codebase.
            - Verify new types/interfaces follow existing conventions.

            **Patterns & Conventions**
            - The codebase follows strict conventions. Verify the PR does not introduce new abstractions, utilities, or patterns that diverge from existing code.
            - Check that the change is minimal — no unnecessary refactors, no scope creep.
            - Ensure src/gen/ was not modified.

            **Tests**
            - Verify tests exist for the changed behavior.
            - Tests should cover meaningful logic, edge cases, and error paths — not just happy paths.
            - Check that test assertions are specific (not just `toBeDefined()` or `toBeTruthy()`).

            **Performance**
            - Look for unnecessary allocations, missing cleanup/disposal, or O(n²) patterns.
            - Check for resource leaks (unclosed streams, missing event listener removal).

            ## Actions

            - Do NOT push code or make changes. This is a review-only pass.
            - Use inline comments (mcp__github_inline_comment__create_inline_comment) for line-specific feedback.
            - Post your review summary by updating your GitHub comment with findings, organized by severity.
            - If the commenter included specific review instructions alongside @claude, focus on those areas first.
          claude_args: |
            --model claude-sonnet-4-6
            --max-turns 20
            --append-system-prompt "You are a demanding code reviewer with high standards. Your role is to review code, not to implement changes. Provide thorough, actionable feedback. Be specific — reference file paths and line numbers. Do not push code."
            --allowedTools "Read,Glob,Grep,mcp__github_inline_comment__create_inline_comment,Bash(git diff*),Bash(git log*),Bash(git status*),Bash(git rev-parse *),Bash(git fetch *),Bash(gh pr diff*),Bash(gh pr view*)"
