name: Claude CI Fix

on:
  workflow_run:
    workflows: ["Pull Request Update"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Failed workflow run ID (from gh run list)'
        required: true
      branch:
        description: 'PR branch name (e.g., claude/SDK-123)'
        required: true

jobs:
  call-ci-fix:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'failure' &&
        startsWith(github.event.workflow_run.head_branch, 'claude/')
      )
    # viamrobotics/claude-ci-workflows@v1.6.1
    uses: viamrobotics/claude-ci-workflows/.github/workflows/claude-ci-fix.yml@efc428a839b04cf3f135ad11ac0cae1e8e247aa1
    with:
      run_id: ${{ github.event.workflow_run.id || inputs.run_id }}
      branch: ${{ github.event.workflow_run.head_branch || inputs.branch }}
      install_command: npm ci && make build-buf
      allowed_tools: 'Edit,Read,Write,Glob,Grep,Bash(npm run build*),Bash(npm run lint*),Bash(npm run typecheck*),Bash(npm run _prettier*),Bash(git config *),Bash(git add *),Bash(git commit *),Bash(git push *),Bash(git status*),Bash(git diff*),Bash(git log*),Bash(git checkout *),Bash(git branch *),Bash(git rev-parse *),Bash(git fetch *)'
      team_mention: '@viamrobotics/sdk'
      extra_prompt: |
        - Run `npm run lint` and `npm run typecheck` to verify your fix before committing. Fix any errors.
      extra_system_prompt: |
        NEVER modify .github/, Makefile, src/gen/, or package-lock.json.
        Only run make build-buf to generate src/gen/. Do NOT run other make targets.
        Always prefer dedicated tools (Grep, Glob, Read, Edit, Write) over Bash equivalents.
        Minimize turns: chain Bash commands with &&, avoid re-reading files you already explored, do not use TodoWrite.
        Bash commands in CI CANNOT use pipes, command substitution, or shell redirection.
        Do NOT run tests — they require e2e infrastructure not available here.
        verbatimModuleSyntax is enabled — type-only imports MUST use the type keyword (e.g., import type { Options } from '../../types').
        Before creating a new file, read 1-2 existing files of the same kind to match patterns exactly.
        Strict TypeScript checks enabled: noUncheckedIndexedAccess, strict, noUnusedLocals, noUnusedParameters.
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GIT_ACCESS_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
