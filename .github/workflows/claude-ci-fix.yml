name: Claude CI Fix

# Automatically retries CI failures on PRs opened by Claude (claude/* branches).
# Caps at 2 fix attempts using labels to track retries.

on:
  workflow_run:
    workflows: ["Pull Request Update"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Failed workflow run ID (from gh run list)'
        required: true
      branch:
        description: 'PR branch name (e.g., claude/SDK-123)'
        required: true

permissions:
  contents: read

jobs:
  fix-ci:
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    if: >-
      github.repository_owner == 'viamrobotics' &&
      (
        github.event_name == 'workflow_dispatch' ||
        (
          github.event.workflow_run.conclusion == 'failure' &&
          startsWith(github.event.workflow_run.head_branch, 'claude/')
        )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Get PR and check retry count
        id: check
        # actions/github-script@v8.0.0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const branch = context.payload.workflow_run?.head_branch || '${{ inputs.branch }}';
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (pulls.length === 0) {
              core.info('No open PR found for branch ' + branch);
              core.setOutput('should_fix', 'false');
              return;
            }

            const pr = pulls[0];
            const labels = pr.labels.map(l => l.name);

            if (labels.includes('claude-fix-2')) {
              core.info(`PR #${pr.number}: max fix attempts (2) reached, skipping`);
              core.setOutput('should_fix', 'false');
              core.setOutput('max_reached', 'true');
              core.setOutput('pr_number', String(pr.number));
              return;
            }

            const attempt = labels.includes('claude-fix-1') ? 2 : 1;
            core.info(`PR #${pr.number}: fix attempt ${attempt} of 2`);
            core.setOutput('should_fix', 'true');
            core.setOutput('pr_number', String(pr.number));
            core.setOutput('attempt', String(attempt));
            core.setOutput('branch', branch);

      - name: Label fix attempt
        if: steps.check.outputs.should_fix == 'true'
        # actions/github-script@v8.0.0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.check.outputs.pr_number }}'),
              labels: ['claude-fix-${{ steps.check.outputs.attempt }}']
            });

      - name: Get failure logs
        if: steps.check.outputs.should_fix == 'true'
        id: logs
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.event.workflow_run.id || inputs.run_id }}
          GH_REPO: ${{ github.repository }}
        run: |
          LOGS=$(gh run view "$RUN_ID" \
            --repo "$GH_REPO" \
            --log-failed 2>&1 | tail -500)
          {
            echo "content<<__CLAUDE_LOGS_EOF_7f3a__"
            echo "$LOGS"
            echo "__CLAUDE_LOGS_EOF_7f3a__"
          } >> "$GITHUB_OUTPUT"

      # actions/checkout@v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        if: steps.check.outputs.should_fix == 'true'
        with:
          ref: ${{ steps.check.outputs.branch }}
          fetch-depth: 1

      # anthropics/claude-code-action@v1.0.48
      - uses: anthropics/claude-code-action@23ed4cb53d6eacddbc22ec16652c98bcc54e0476
        if: steps.check.outputs.should_fix == 'true'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: .claude/settings.ci.json
          prompt: |
            CI failed on PR #${{ steps.check.outputs.pr_number }} (fix attempt ${{ steps.check.outputs.attempt }} of 2).

            The PR is on branch `${{ steps.check.outputs.branch }}`. Fix the issues and push to this branch.

            CI failure logs:
            ```
            ${{ steps.logs.outputs.content }}
            ```

            Instructions:
            - Read CLAUDE.md for repository conventions and constraints.
            - Analyze the failure logs to understand what went wrong.
            - Make the minimal fix to resolve the CI failures.
            - Run `npm run _prettier -- --write` and `npm run lint:prettier` before pushing.
            - Do NOT attempt to run ESLint, typecheck, or tests â€” they require permissions and tooling that are not available.
            - Use the Grep and Glob tools for searching code. Do NOT use Bash to run grep or find commands.
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 20
            --allowedTools "Edit,Read,Write,Glob,Grep,Bash(npm ci*),Bash(npm run _prettier*),Bash(npm run lint:prettier*),Bash(git add *),Bash(git commit *),Bash(git push *),Bash(git status*),Bash(git diff*),Bash(git log*),Bash(git checkout *),Bash(git branch *),Bash(git rev-parse *),Bash(git fetch *)"

      - name: Comment on PR if max retries exhausted
        if: steps.check.outputs.max_reached == 'true'
        # actions/github-script@v8.0.0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.check.outputs.pr_number }}'),
              body: '@sdk CI is still failing after 2 automated fix attempts. This PR needs human intervention.'
            });

      - name: Comment on PR if fix attempt failed
        if: failure() && steps.check.outputs.should_fix == 'true'
        # actions/github-script@v8.0.0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.check.outputs.pr_number }}'),
              body: '@sdk Automated fix attempt ${{ steps.check.outputs.attempt }} of 2 failed. This PR may need human intervention.'
            });
