name: Claude Jira Implementation

# Triggered by Jira webhook via middleware that calls GitHub repository_dispatch API.
# Expected payload:
#   curl -X POST -H "Authorization: token $GITHUB_PAT" \
#     https://api.github.com/repos/viamrobotics/viam-typescript-sdk/dispatches \
#     -d '{"event_type":"jira-ticket","client_payload":{"ticket_id":"SDK-123","summary":"...","description":"..."}}'

on:
  repository_dispatch:
    types: [jira-ticket]
  workflow_dispatch:
    inputs:
      ticket_id:
        description: 'Jira ticket ID (e.g., SDK-123)'
        required: true
      summary:
        description: 'Ticket summary'
        required: true
      description:
        description: 'Ticket description'
        required: true

permissions:
  contents: read

jobs:
  implement:
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    if: github.repository_owner == 'viamrobotics'
    runs-on: ubuntu-latest
    steps:
      # actions/checkout@v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 1

      # anthropics/claude-code-action@v1.0.48
      - uses: anthropics/claude-code-action@23ed4cb53d6eacddbc22ec16652c98bcc54e0476
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: .claude/settings.ci.json
          prompt: |
            Implement the following Jira ticket:

            Ticket: ${{ github.event.client_payload.ticket_id || inputs.ticket_id }}
            Summary: ${{ github.event.client_payload.summary || inputs.summary }}
            Description: ${{ github.event.client_payload.description || inputs.description }}

            Follow these steps in order:
            1. Read CLAUDE.md for repository conventions and constraints.
            2. Explore the relevant source files to understand the existing code and patterns.
            3. Think hard: consider at least two approaches, then select the one with the smallest diff and lowest risk that satisfies the acceptance criteria.
            4. Implement the change. Add or update unit tests for changed behavior.
            5. Run `npm ci`, then `npm run _prettier -- --write`, then `npm run lint:prettier`.
            6. Open a PR with the Jira ticket ID in the title. The PR description must include a summary of what changed and why.

            Do NOT run ESLint, typecheck, or tests, they require permissions and tooling not available here.
          show_full_output: true
          claude_args: |
            --model claude-opus-4-6
            --max-turns 40
            --append-system-prompt "Before modifying any file, explore the relevant code first. Consider alternative approaches and select the smallest, safest change that reuses existing patterns. Do not introduce new abstractions or refactor beyond what is needed."
            --allowedTools "Edit,Read,Write,Glob,Grep,Bash(npm ci*),Bash(npm run _prettier*),Bash(npm run lint:prettier*),Bash(git add *),Bash(git commit *),Bash(git push *),Bash(git status*),Bash(git diff*),Bash(git log*),Bash(git checkout *),Bash(git branch *),Bash(git rev-parse *),Bash(git fetch *),Bash(gh pr create*)"

      - name: Notify Slack of failure
        # slackapi/slack-github-action@v1.27.1
        uses: slackapi/slack-github-action@fcfb566f8b0aab22203f066d80ca1d7e4b5d05b3
        if: ${{ failure() }}
        with:
          payload: |
            {
              "text": "Claude Jira implementation failed for ${{ github.event.client_payload.ticket_id || inputs.ticket_id }}: ${{ github.event.client_payload.summary || inputs.summary }}\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "username": "Typescript SDK",
              "icon_url": "https://media.tenor.com/bZMubztJxGkAAAAe/charlie-brown-walking-charlie-brown.png"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_TEST_WEBHOOK_URL }}
